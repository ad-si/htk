# This is the top-level directory for UniForM.  Like all the other
# makefiles in uni its main purpose is to set the variables required by
# mk/suffix.mk (see that for more details).  We also implement
# tarball.tar.gz which should gzip all source files to make tarball.tar.gz
#
# SUBDIRS is a list of all directories containing code to be compiled to
# form the UniForM workbench, in an order in which they can be compiled
# by recursively calling $(MAKE) -C (subdir) lib.
ifeq "@WINDOWS@" "1"
   SUBDIRS = util events reactor htk
else
   SUBDIRS= util events reactor posixutil htk server graphs davinci cvs types
endif

include @TOP@/mk/boilerplate.mk 

# Tarballs:
# These targets are for experts only, so feel free to hack away if they
# don't work.

# By making tarball.tar.gz and tarball.objects.tar.gz .PHONY we
# ensure that they always get remade whenever "gmake tarball.tar.gz"
# or "gmake tarball.objects.tar.gz" are executed.
.PHONY : tarball.tar.gz tarball.objects.tar.gz findsources exports.tar.gz

findsources :
	@$(MAKE) displaysrcs -s --no-print-directory
	@echo @TOP@/mk/boilerplate.mk.in @TOP@/mk/machinedep.mk.in 
	@echo @TOP@/mk/var.mk @TOP@/mk/suffix.mk @TOP@/mk/local.mk.debug
	@echo @TOP@/configure.in 


COMMONTOPEXPORTS = uni-package.conf.export mk/FixFileNames includes/*.h

ifeq "@WINDOWS" "1"
TOPEXPORTS = INSTALL.BAT GHCHTK.BAT.export GHCIHTK.BAT.export $(COMMONTOPEXPORTS) 
else
TOPEXPORTS = install ghchtk.export ghcihtk.export $(COMMONTOPEXPORTS)
endif

exports.tar.gz :
	cd @TOP@;@TAR@ -czf exports.tar.gz `(($(MAKE) -s --no-print-directory displayexports) | @SED@ "s+^@TOP@/++;s+ @TOP@/+ +g;") ; echo $(TOPEXPORTS)`

exports.zip :
	cd @TOP@; (($(MAKE) -s --no-print-directory displayexports) | @SED@ "s+^@TOP@/++;s+ @TOP@/+ +g;") ; echo $(TOPEXPORTS) | @ZIP@ -9@ exports.zip

tarball.tar.gz:
	cd @TOP@;@TAR@ -czf tarball.tar.gz `(($(MAKE) -s --no-print-directory findsources) | sed "s+^@TOP@/++;s+ @TOP@/+ +g;") ; echo README ; echo configure`

# tar of all object and .hi files (but not .depend/library/exec files which 
# are cheaper to regenerate)
tarball.objects.tar.gz:
	@TAR@ -czf tarball.objects.tar.gz `gfind . '(' -name '*.o' -o -name '*.hi' ')' `

